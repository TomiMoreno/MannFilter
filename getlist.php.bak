<html>
    <head>
    <meta charset="UTF-8"> <!-- corregir los caracteres con UTF-8 -->
    <script type="text/javascript" language="Javascript">
            document.oncontextmenu = function(){return false}   
        </script>
        <link rel="shortcut icon" href="img/logo.jpg">
        <link rel="stylesheet" type="text/css" href="css/tablas.css">
        <link rel="stylesheet" type="text/css" href="css/buttons.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <link rel="stylesheet" type="text/css" href="css/textos.css">

        <script src="js/functionestado.js" type="text/javascript"></script> <!--FALTABA TEXT/JAVASCRIPT E IBA EN EL HEAD -->
    </head>
    <body>
        <span id="estadoSeleccionado"></span>

        <!-- ***************************** !-->
        <br> <br>
        <form action="pedidos.php">
            <button type="submit" class="button1">Volver a la pagina principal</button>
        </form>
        <?php
            //Conexión con la base de datos
            session_start();
            include 'conexion.php';
            //Declaro la variable mediante POST
            $supplier = $_SESSION['supplier'];
            //echo $supplier; es a modo de debug

            //****** ESTO ES PARA ORDENAR LAS COLUMNAS ****////
            $order="";

            if (isset($_GET['columna'])) {
                $order = " order by " .$_GET['columna']." ".$_GET['tipo']; 
            }   

            //***************************************************
            
            //*************** MODIFICADO POR PCR ******************
            //TRAIGO EL NOMBRE DEL PROVEEDOR
            $sql = "SELECT name FROM pedidos WHERE supplier = '".$supplier."' LIMIT 1";
            //Envía respuesta
            $respuesta = mysqli_query($conexion, $sql);
            $row = mysqli_fetch_array($respuesta);
            echo "<h1>" .$row[0]. "</h1>";
            echo "<br>";
            //******************************************************

            //Consulta y filtra por columna "document_number"
            $sql = "SELECT * FROM pedidos WHERE supplier = '".$supplier."' AND en_stock='0' $order;";
            $sqlestado = "SELECT * FROM estado_pedidos WHERE status = '0' ORDER BY Id DESC";
            //Envía respuesta
            $respuestaestados = mysqli_query($conexion, $sqlestado);
            $numero_estados = mysqli_num_rows($respuestaestados);
            
            $i = 0;
            while($rowestado = mysqli_fetch_array($respuestaestados)){
                $cod_estados[$i]=$rowestado['estado_pedido'];
                $desc_estados[$i]=$rowestado['name'];
                $i++;

            }

            $respuesta = mysqli_query($conexion, $sql);
            $numero = mysqli_num_rows($respuesta);
            //Creación de tabla

            
            //*************** MODIFICADO POR PCR ******************
            $columna = isset($_GET['columna'])?$_GET['columna']:null;
            $tipo = isset($_GET['tipo'])?$_GET['tipo']:null;
            echo "Se han encontrado ".$numero." pedidos pendientes";
            echo "<button class='exportar' id='exportar' type='button' onclick='exportList()'>EXPORTAR A EXCEL</button>"; //para exportar pedidos
            echo"<table id='listado'>
                <tr>
                <th> Documento </th>
                <th> Material"; ordenador($columna, 'material', $tipo);
            echo"</th>
                <th> Descripción"; ordenador($columna, 'description', $tipo);
            echo"</th>
                <th> Cantidad </th>
                <th> Fecha"; ordenador($columna, 'date_of_sc', $tipo);
            echo"</th>
                <th> Estado </th>
                <th> Fecha esperada </th>
                <th> Validar </th>
                </tr>";

            //creamos una variable para enviar a validarEstado
            $contador = 1;

            //Coloca los datos en la tabla
            while($row = mysqli_fetch_array($respuesta)){
                echo "<tr>";
                echo "<td>" .$row['document_number'] . "</td>";
                echo "<td>" .$row['material'] . "</td>";
                echo "<td>" .$row['description'] . "</td>";
                echo "<td>" .$row['ordered quantit'] . "</td>";

                //**********WARGINGS CON COLORES DEPENDIENDO DE LOS DÍAS HASTA LE FECHA DE ENTREGA**********
                //dependiendo de los días hasta la fecha de entrega, asigna estilos a las celdas
                date_default_timezone_set('UTC');
                $fecha = new DateTime($row['date_of_sc']);
                $hoy = new DateTime(date("Y-m-d"));
                $diferencia = $hoy->diff($fecha);
                $dias=$diferencia->days;
                
                //SI LA FECHA ESTÁ ATRASADA, VA EN ROJO
                if($hoy>=$fecha)
                {

                    echo "<td class='rojo'>" .$row['date_of_sc'] . "</td>";
                  

                }
                else
                {

                    //si la fecha supera las 3 semanas, el color es verde
                if($dias>=21)
                {
                    echo "<td class='verde'>" .$row['date_of_sc'] . "</td>";
                
                }

                //si la fecha está entre 2 y 3 semanas, el color es amarillo
                if(($dias>=14) && ($dias<21))
                {
                    echo "<td class='amarillo'>" .$row['date_of_sc'] . "</td>";
                
                }

                //si la fecha está entre 1 y 2 semanas, el color es naranja
                if(($dias>=3) && ($dias<14))
                {
                    echo "<td class='naranja'>" .$row['date_of_sc'] . "</td>";
                  
                }

                
                //si la fecha está a menos de 3 dias, el color es rojo
                if($dias<3)
                {
                   echo "<td class='rojo'>" .$row['date_of_sc'] . "</td>";
                  
                }


                }
                
       

                //*******************************************************************************************

                echo "<td><select id='".$contador."' onchange='seleccionarEstado(".$contador.")'>";
                
                //**********LEVANTAR LOS ESTADOS DESDE LA TABLA ESTADO_PEDIDOS***********/

                $i = 0;
                while($i<$numero_estados){
                    echo   "<option value='".$cod_estados[$i]."' ";
                    if($cod_estados[$i]==$row['estado_pedido']){
                        echo "selected";
                    }

                    echo ">".$desc_estados[$i]." - ".$cod_estados[$i];    
                    $i++;
    
                }
                echo "</select>";
                echo "<br>Obs ";
                echo "<input type='text' id='obs".$contador."'>";
                //*******************************************************************/


                //*****ESTE SWITCH ES PARA QUE LOS COMBOS SE CARGUEN DE ACUERDO A LA TABLA DE PEDIDOS*****

                

                
                //***************************************************************************************
                echo "<td><input type='date' name='fech' id='in".(string)$contador."' value='".$row['date_of_sc']."' disabled='true'></td>"; //se cambió la fecha del input por la fecha del campo
                echo "<td> <input type='button' name='validar' value='VALIDAR' onclick='validarEstado(".$contador.")'> </td>";
                echo "</tr>";
                //Incrementamos de a uno el contador
                $contador = $contador + 1;
            
            }
                echo "</table>";


                //****************************************************
            
            ///////***********FUNCION PARA ORDENAR ASC O DESC **************///////////////
                function ordenador($columnaslec, $columnaValor, $tipoOrden) {
            ?>
            <?php if (isset($columnaslec) && $columnaslec == $columnaValor && $tipoOrden=='asc'): ?>
            <button type="button" disabled>Descendente</button>    
            <?php else: ?>  
            <a href="getlist.php?columna=<?php echo $columnaValor; ?>&tipo=asc"><button type="button">Descendente</button></a>
            <?php endif; ?>
            <?php if (isset($columnaslec) && $columnaslec == $columnaValor && $tipoOrden=='desc'): ?>
            <button disabled>Ascendente</button></a>
            <?php else: ?>
            <a href="getlist.php?columna=<?php echo $columnaValor; ?>&tipo=desc"><button>Ascendente</button></a>
            <?php endif; ?>
            <?php     }
            //************************************************************************
            //Cierra la conexión
            mysqli_close($conexion);
        ?>
    </body>
</html>